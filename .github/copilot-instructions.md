# Copilot / AI Agent Instructions â€” LiveChat (NexGen Telegram Chat)

Purpose: quickly orient an AI coding agent to be productive in this WordPress plugin repository.

Key context
- Project type: WordPress plugin (PHP backend + frontend JS/CSS). See README for intent and install notes.
- Main entry: [nexgen-telegram-chat.php](nexgen-telegram-chat.php) â€” bootstrap file that loads all service classes.
- Frontend: [assets/chat.js](assets/chat.js) â€” UI logic, polling, AJAX calls, sessionStorage usage.

Big-picture architecture (Service-Oriented - v3.0.0+)
- Plugin uses **service classes** for clean separation of concerns:
  - `[includes/class-plugin.php](includes/class-plugin.php)` â€” Main plugin class, registers WordPress hooks, routes AJAX calls
  - `[includes/class-security.php](includes/class-security.php)` â€” Nonce verification, input validation, rate limiting, XSS/SQL injection checks
  - `[includes/class-session-service.php](includes/class-session-service.php)` â€” Session management, visitor name handling, session ID generation
  - `[includes/class-message-service.php](includes/class-message-service.php)` â€” Database CRUD operations for messages
  - `[includes/class-telegram-service.php](includes/class-telegram-service.php)` â€” Telegram Bot API integration, webhook handling
  - `[includes/class-n8n-service.php](includes/class-n8n-service.php)` â€” N8N automation workflow routing (Phase 2)
  - `[includes/admin-page.php](includes/admin-page.php)` â€” Admin settings page template

- Frontend <-> backend flow:
  - `assets/chat.js` calls AJAX actions via `admin-ajax.php` using the localized `nexgen_chat_ajax` object
  - AJAX handlers in `NexGen_Telegram_Chat` (`class-plugin.php`) route requests to appropriate services
  - Messages persisted in `$wpdb->prefix . 'nexgen_chat_messages'` (created via `NexGen_Message_Service::create_table()`)
  - Telegram outbound uses `NexGen_Telegram_Service::send_message()` (Bot API `sendMessage`)
  - Inbound webhooks routed to `NexGen_Telegram_Service::handle_webhook()`

Important conventions & patterns (project-specific)
- Session ID format: `chat_<slug>_<6-hex>` â€” generated by `NexGen_Session_Service::generate_session_id()`. Always validate with `NexGen_Security::validate_session_id()`.
- Message parsing for replies: bot replies extracted by regex matching `ðŸ”— SesiÃ³n: chat_xxx_yyyyyy` in `NexGen_Telegram_Service::process_reply_to_message()`. Do not change token unless updating both send/receive.
- AJAX nonce: `nexgen_chat_nonce` â€” all handlers verify via `NexGen_Security::verify_nonce()`. JS uses `nexgen_chat_ajax.nonce`.
- Settings keys: `nexgen_bot_token`, `nexgen_chat_id`, `nexgen_welcome_message`, `nexgen_primary_color`, etc. Registered in `NexGen_Telegram_Chat::admin_init()`.
- Polling: frontend polls every 3000ms (configurable) via `NexGen_Message_Service::get_messages($session_id, $last_message_id)`.
- Sessions: PHP `$_SESSION` stores `nexgen_chat_session` (ID) and `nexgen_chat_name` (visitor name). JS mirrors name in `sessionStorage`.

Service class naming conventions
- All service classes use `NexGen_` prefix (e.g., `NexGen_Security`, `NexGen_Message_Service`)
- Exception: main plugin class is `NexGen_Telegram_Chat`
- Use static methods for utilities/singletons (Security, Session, Message CRUD)
- Throw `Exception` for errors, handlers catch and log via `NexGen_Security::log_event()`

Security & validation patterns
- All AJAX handlers MUST call `if ( ! NexGen_Security::verify_nonce() ) wp_send_json_error()` first
- All input must be validated with `NexGen_Security::validate_message()` and `sanitize_text_field()`
- Rate limiting via `$rate_limit = NexGen_Security::check_rate_limit( $session_id )` (20 msgs/min per session)
- Admin-only operations check `current_user_can('manage_options')` before executing
- XSS protection: `NexGen_Security::escape_message()` when displaying user content
- SQL injection protection: Always use `$wpdb->prepare()` for queries (see `NexGen_Message_Service`)
- Logging: Use `NexGen_Security::log_event( 'event_name', [ 'data' => 'value' ] )` â€” requires `WP_DEBUG`
- DB writes: Use `NexGen_Message_Service::save_message()` which handles sanitization and hashing

Developer workflows & quick commands
- There is no standalone test harness â€” run and debug inside a local WP environment (LocalWP / Docker / XAMPP). Steps to test key flows:
  1. Install the plugin ZIP or copy these files into `wp-content/plugins/nexgen-telegram-chat`.
  2. Activate plugin in WP admin.
  3. Configure `nexgen_bot_token` and `nexgen_chat_id` in the plugin admin page rendered by `admin_page()`.
  4. Use the admin UI buttons to `Enviar mensaje de prueba` (calls `nexgen_debug_test`) and `Configurar Webhook` (calls `nexgen_set_webhook`).
- To simulate inbound Telegram replies locally, POST JSON to `admin-ajax.php?action=nexgen_telegram_webhook` with the same structure Telegram sends; the plugin logs webhook input when `WP_DEBUG` is true.

Files to inspect when making changes
- [nexgen-telegram-chat.php](nexgen-telegram-chat.php) â€” plugin bootstrap (35 lines), loads all services
- [includes/class-plugin.php](includes/class-plugin.php) â€” main hooks, AJAX handlers routing, admin page
- [includes/class-security.php](includes/class-security.php) â€” nonce, validation, rate limiting, logging utilities
- [includes/class-session-service.php](includes/class-session-service.php) â€” session ID generation (chat_<slug>_<6-hex> format)
- [includes/class-message-service.php](includes/class-message-service.php) â€” DB CRUD, message save/retrieve, table schema
- [includes/class-telegram-service.php](includes/class-telegram-service.php) â€” Telegram API, webhook handling, reply parsing
- [includes/class-n8n-service.php](includes/class-n8n-service.php) â€” N8N webhook integration (skeleton, Phase 2)
- [includes/admin-page.php](includes/admin-page.php) â€” admin settings UI template
- [assets/chat.js](assets/chat.js) â€” frontend polling, AJAX calls, UI state
- [assets/chatbot.css](assets/chatbot.css) â€” CSS variables (--primary-color), responsive layout

What to avoid changing without coordinated edits
- The literal message format that includes `ðŸ”— SesiÃ³n:` and the session id â€” it's used to tie Telegram replies back to session state. If you change the token/string, update both `send_to_telegram()` and `process_reply_to_message()` simultaneously.
- The AJAX `action` names and nonce behavior â€” JS and PHP must match exactly.

Examples (copy-paste friendly)
- Sending a message via service:

```php
// In a handler or service method
try {
  $validation = NexGen_Security::validate_message( $_POST['message'] );
  if ( ! $validation['valid'] ) {
    wp_send_json_error( $validation['error'] );
  }
  
  // Check rate limit
  $limit = NexGen_Security::check_rate_limit( $session_id );
  if ( ! $limit['allowed'] ) {
    wp_send_json_error( 'Too many messages' );
  }
  
  // Save locally and send to Telegram
  NexGen_Message_Service::save_message( $session_id, $validation['message'], 'user' );
  $result = NexGen_Telegram_Service::send_message( $validation['message'], $session_id );
  
  if ( ! $result['success'] ) {
    wp_send_json_error( $result['error'] );
  }
  wp_send_json_success( 'Message sent' );
} catch ( Exception $e ) {
  NexGen_Security::log_event( 'send_message_error', [ 'error' => $e->getMessage() ] );
  wp_send_json_error( $e->getMessage() );
}
```

- Handling webhook reply:

```php
// In NexGen_Telegram_Service::process_reply_to_message()
if ( preg_match( '/ðŸ”— SesiÃ³n: (chat_[A-Za-z0-9\-]+_[A-Fa-f0-9]{6})/', $original_message, $matches ) ) {
  $session_id = $matches[1];
  NexGen_Message_Service::save_message( $session_id, $reply_text, 'bot' );
}
```

Patch & PR guidelines for agents
- Make minimal, focused edits. If altering the message format or session semantics, include coordinated changes to both PHP and JS, and update this instructions file.
- Preserve user-facing strings (Spanish) or keep translations consistent.
- Phase 1 (Architecture v3.0.0) is complete. Future work focuses on Phase 2 (N8N) and Phase 3 (Security hardening).

If anything here is unclear or missing, tell me which area you want expanded (webhook testing, message schema, or admin flows) and I'll update this file.
